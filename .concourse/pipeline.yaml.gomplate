# The config.yaml file is a collection of settings one might want to change
# if they are deploying a second copy of the kubecf pipeline.
# It is meant to provide a way to not pollute the "production" resources with
# data from testing and developing the pipeline.
# The production pipeline should always be deployed without a config.yaml.
# This will use the same (default) values every time, so people deploying it
# don't have to know what kind of values were used when it was deployed last
# time.

# Variables
{{ $availableCfSchedulers := slice "diego" "eirini" }} # Diego / Eirini
{{ $pr_resources := slice "pr" "fork-pr" }}
{{ $branches := slice "master" "release-2.2"}} # Repository branches to track

# Split Concourse jobs in tabs (aka groups)
# We split by "branch" and we also split the "experimental" jobs of each branch.

# Stable Jobs
# TODO: Delete the special case here as soon as we get Eirini CATS green and we stabilize Eirini smoke (e.g. with a more large timeout)
{{ $stable := slice "lint" "build" "deploy-diego" "deploy-eirini" "smoke-tests-diego" "smoke-tests-eirini" "cf-acceptance-tests-diego" "cleanup-diego-cluster" "cleanup-eirini-cluster" }}
{{ $experimental := slice "cf-acceptance-tests-eirini" "sync-integration-tests" "ccdb-rotate-diego" "ccdb-rotate-eirini" "smoke-tests-post-rotate-diego" "smoke-tests-post-rotate-eirini" "upgrade-test" }}

groups:
{{ range $_, $branch := (flatten (slice $branches $pr_resources) | uniq) }}
- name: {{ $branch }}
  jobs:
  {{ range $_, $job := $stable }}
  - {{ $job }}-{{ $branch }}
  {{ end }}
  {{ if not ($branch | regexp.Match "^pr|fork-pr") }}
  - publish-{{ $branch }}
  {{ end }}
- name: {{ $branch }}-experimental
  jobs:
  {{ range $_, $job := $experimental }}
  - {{ $job }}-{{ $branch }}
  {{ end }}
{{ end }}

resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: teliaoss/github-pr-resource

- name: github-status
  type: docker-image
  source:
    repository: resource/github-status
    tag: release

resources:
- name: kubecf-github-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: kubecf
    access_token: ((github-access-token))

{{ range $_, $branch := (flatten (slice $branches $pr_resources) | uniq) }}
{{- range $_, $cfScheduler := $availableCfSchedulers }}
- name: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
  type: semver
  source:
    driver: s3
    bucket: {{ if has . "s3_bucket" }}{{ .s3_bucket }}{{ else }}kubecf-ci{{ end }}
    key: gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    initial_version: 0.0.1
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_bucket_region" }}{{ .s3_bucket_region }}{{ else }}"eu-central-1"{{ end }}
{{ end }} # availableCfSchedulers

- name: semver.gke-cluster-{{ $branch }}-upgrade
  type: semver
  source:
    driver: s3
    bucket: {{ if has . "s3_bucket" }}{{ .s3_bucket }}{{ else }}kubecf-ci{{ end }}
    key: gke-cluster-{{ $branch }}-upgrade
    initial_version: 0.0.1
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_bucket_region" }}{{ .s3_bucket_region }}{{ else }}"eu-central-1"{{ end }}
{{ end }} # prs and branches (flattened)


{{- range $_, $branch := $branches }}
- name: kubecf-{{ $branch }}
  type: git
  source:
    branch: {{ $branch }}
    uri: https://github.com/{{ if has . "kubecf_repository" }}{{ .kubecf_repository }}{{ else }}{{ "cloudfoundry-incubator/kubecf" }}{{ end }}
- name: status-{{ $branch }}.src
  type: github-status
  source:
    repo: {{ if has . "kubecf_repository" }}{{ .kubecf_repository }}{{ else }}{{ "cloudfoundry-incubator/kubecf" }}{{ end }}
    access_token: ((github-access-token))
{{ end }}

- name: kubecf-pr
  type: pull-request
  check_every: 10m
  source:
    repository: {{ if has . "kubecf_repository" }}{{ .kubecf_repository }}{{ else }}{{ "cloudfoundry-incubator/kubecf" }}{{ end }}
    access_token: ((github-access-token))
    disable_forks: true # Trigger on kubecf branches only
    required_review_approvals: 1

- name: kubecf-fork-pr
  type: pull-request
  check_every: 10m
  source:
    repository: {{ if has . "kubecf_repository" }}{{ .kubecf_repository }}{{ else }}{{ "cloudfoundry-incubator/kubecf" }}{{ end }}
    access_token: ((github-access-token))
    disable_forks: false # Trigger on kubecf branches only
    required_review_approvals: 1

{{- range $_, $pr := $pr_resources }}

- name: status-{{$pr}}.src
  type: github-status
  source:
    repo: {{ if has . "kubecf_repository" }}{{ .kubecf_repository }}{{ else }}{{ "cloudfoundry-incubator/kubecf" }}{{ end }}
    access_token: ((github-access-token))

{{- end }}

- name: catapult
  type: git
  source:
    uri: https://github.com/SUSE/catapult
  version:
    ref: 76182e1e21f13b5143cfc275ee818a81570e8b32

- name: s3.kubecf-ci
  type: s3
  source:
    bucket: {{ if has . "s3_bucket" }}{{ .s3_bucket }}{{ else }}kubecf-ci{{ end }}
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_bucket_region" }}{{ .s3_bucket_region }}{{ else }}"eu-central-1"{{ end }}
    regexp: kubecf-v(.*).tgz

- name: s3.kubecf-ci-bundle
  type: s3
  source:
    bucket: {{ if has . "s3_bucket" }}{{ .s3_bucket }}{{ else }}kubecf-ci{{ end }}
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_bucket_region" }}{{ .s3_bucket_region }}{{ else }}"eu-central-1"{{ end }}
    regexp: kubecf-bundle-v(.*).tgz

- name: s3.kubecf
  type: s3
  source:
    bucket: {{ if has . "s3_final_bucket" }}{{ .s3_final_bucket }}{{ else }}kubecf{{ end }}
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_final_bucket_region" }}{{ .s3_final_bucket_region }}{{ else }}"us-west-2"{{ end }}
    regexp: kubecf-v(.*).tgz

- name: s3.kubecf-bundle
  type: s3
  source:
    bucket: {{ if has . "s3_final_bucket" }}{{ .s3_final_bucket }}{{ else }}kubecf{{ end }}
    access_key_id: ((aws-access-key))
    secret_access_key: ((aws-secret-key))
    region_name: {{ if has . "s3_final_bucket_region" }}{{ .s3_final_bucket_region }}{{ else }}"us-west-2"{{ end }}
    regexp: kubecf-bundle-v(.*).tgz

deploy_args: &deploy_args
- -ce
- |

  # Login to gcloud
  printf "%s" '((gke-suse-cap-json))' > $PWD/gke-key.json
  export GKE_CRED_JSON=$PWD/gke-key.json
  gcloud auth activate-service-account --key-file $PWD/gke-key.json

  export GKE_PROJECT={{ if has . "gke_project" }}{{ .gke_project }}{{ else }}"suse-225215"{{ end }}
  export GKE_CLUSTER_ZONE={{ if has . "gke_zone" }}{{ .gke_zone }}{{ else }}"europe-west3-c"{{ end }}
  export GKE_CLUSTER_NAME="kubecf-ci-${BRANCH}-${CFSCHEDULER}-$(cat semver.gke-cluster/version | sed 's/\./-/g')"

  gcloud --quiet beta container \
    --project "${GKE_PROJECT}" clusters create "${GKE_CLUSTER_NAME}" \
    --zone "${GKE_CLUSTER_ZONE}" \
    --no-enable-basic-auth \
    --machine-type "n1-highcpu-16" \
    --image-type "UBUNTU" \
    --disk-type "pd-ssd" \
    --disk-size "100" \
    --metadata disable-legacy-endpoints=true \
    --scopes "https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/logging.write","https://www.googleapis.com/auth/monitoring","https://www.googleapis.com/auth/servicecontrol","https://www.googleapis.com/auth/service.management.readonly","https://www.googleapis.com/auth/trace.append" \
    --preemptible \
    --num-nodes "1" \
    --enable-stackdriver-kubernetes \
    --enable-ip-alias \
    --network "projects/${GKE_PROJECT}/global/networks/default" \
    --subnetwork "projects/${GKE_PROJECT}/regions/$(echo ${GKE_CLUSTER_ZONE} | sed 's/-.$//')/subnetworks/default" \
    --default-max-pods-per-node "110" \
    --no-enable-master-authorized-networks \
    --addons HorizontalPodAutoscaling,HttpLoadBalancing \
    --no-enable-autorepair \
    --no-enable-autoupgrade \
    --no-enable-autoprovisioning

  # Get a kubeconfig
  gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} --zone ${GKE_CLUSTER_ZONE} --project "${GKE_PROJECT}"

  export SCF_LOCAL="${PWD}/kubecf"
  export SCF_CHART="$(readlink -f s3.kubecf-ci/*.tgz)"
  export SCF_OPERATOR=true
  export FORCE_DELETE=true
  export HELM_VERSION="v3.1.1"
  export SCF_TESTGROUP=true
  export BACKEND=gke
  export DOCKER_ORG=cap-staging
  export QUIET_OUTPUT=true
  export DOWNLOAD_CATAPULT_DEPS=false
  export KUBECFG="$(readlink -f ~/.kube/config)"

  # https://unix.stackexchange.com/a/265151
  read -r -d '' CONFIG_OVERRIDE <<'EOF' || true
  sizing:
    diego_cell:
      ephemeral_disk:
        size: 300000
  EOF
  export CONFIG_OVERRIDE

  pushd catapult
  # Bring up a k8s cluster and builds+deploy kubecf
  # https://github.com/SUSE/catapult/wiki/Build-and-run-SCF#build-and-run-kubecf
  make kubeconfig kubecf

test_args: &test_args
- -ce
- |

  # Login to gcloud
  printf "%s" '((gke-suse-cap-json))' > $PWD/gke-key.json
  export GKE_CRED_JSON=$PWD/gke-key.json
  gcloud auth activate-service-account --key-file $PWD/gke-key.json

  export GKE_PROJECT={{ if has . "gke_project" }}{{ .gke_project }}{{ else }}"suse-225215"{{ end }}
  export GKE_CLUSTER_ZONE={{ if has . "gke_zone" }}{{ .gke_zone }}{{ else }}"europe-west3-c"{{ end }}
  export GKE_CLUSTER_NAME="kubecf-ci-${BRANCH}-${CFSCHEDULER}-$(cat semver.gke-cluster/version | sed 's/\./-/g')"

  # Get a kubeconfig
  gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} --zone ${GKE_CLUSTER_ZONE} --project "${GKE_PROJECT}"

  export BACKEND=gke
  export KUBECF_TEST_SUITE="${TEST_SUITE:-smokes}"
  export SCF_LOCAL="${PWD}/kubecf"
  export KUBECF_NAMESPACE="scf"
  export QUIET_OUTPUT=true
  export DOWNLOAD_CATAPULT_DEPS=false
  export KUBECFG="$(readlink -f ~/.kube/config)"
  export KUBECF_CHECKOUT="${SCF_LOCAL}"
  pushd catapult
  # Grabs back a deployed cluster and runs test suites on it
  # See: https://github.com/SUSE/catapult/wiki/Running-SCF-tests#kubecf
  make kubeconfig tests-kubecf

rotate_args: &rotate_args
- -ce
- |

  # Login to gcloud
  printf "%s" '((gke-suse-cap-json))' > $PWD/gke-key.json
  export GKE_CRED_JSON=$PWD/gke-key.json
  export GKE_PROJECT={{ if has . "gke_project" }}{{ .gke_project }}{{ else }}"suse-225215"{{ end }}
  export GKE_CLUSTER_ZONE={{ if has . "gke_zone" }}{{ .gke_zone }}{{ else }}"europe-west3-c"{{ end }}
  export GKE_CLUSTER_NAME="kubecf-ci-${BRANCH}-${CFSCHEDULER}-$(cat semver.gke-cluster/version | sed 's/\./-/g')"

  gcloud auth activate-service-account --key-file $PWD/gke-key.json
  # Get a kubeconfig
  gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} --zone ${GKE_CLUSTER_ZONE} --project "${GKE_PROJECT}"

  export BACKEND=gke
  export KUBECF_NAMESPACE="scf"
  export QUIET_OUTPUT=true
  export DOWNLOAD_CATAPULT_DEPS=false
  export KUBECFG="$(readlink -f ~/.kube/config)"
  export KUBECF_CHECKOUT="${PWD}/kubecf"
  export KUBECF_INSTALL_NAME="susecf-scf"

  pushd catapult
  make kubeconfig
  source build*/.envrc

  pushd "${KUBECF_CHECKOUT}"
  testing/ccdb_key_rotation/rotate-ccdb-keys-test.sh

jobs:

{{ $path := "" }}
{{- range $_, $branch := flatten (slice $branches $pr_resources)  }}

{{ if or (eq $branch "fork-pr") (eq $branch "pr" )}}
{{ $path = ".git/resource/head_sha" }}
{{ else }}
{{ $path = ".git/short_ref" }}
{{ end }}

{{ $sanitized_branch_name := replaceAll "." "_" $branch }}

- name: lint-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
{{- if ne $branch "fork-pr" }}
    trigger: true
{{- end }}
    version: "every"
{{- if has $stable "lint" }}
  - put: status-{{ $branch }}.src
    params: &lint_{{ $sanitized_branch_name }}_status
        context: lint
        description: "Lint started"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: lint
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: thulioassis/bazel-docker-image
          tag: 2.0.0
      inputs:
      - name: kubecf-{{ $branch }}
      run:
        path: "/bin/bash"
        args:
        - -ce
        - |
          cd kubecf-{{ $branch }}
          ./dev/linters/shellcheck.sh
          ./dev/linters/yamllint.sh
          ./dev/linters/helmlint.sh
          bazel test //rules/kubecf:create_sample_values_test

{{- if has $stable "lint" }}
    on_success:
      put: status-{{ $branch }}.src
      params:
        << : *lint_{{ $sanitized_branch_name }}_status
        state: success
    on_failure:
      put: status-{{ $branch }}.src
      params:
        << : *lint_{{ $sanitized_branch_name }}_status
        state: failure
{{- end }}

- name: build-{{ $branch }}
  public: false # TODO: public or not?
  plan:
  - get: kubecf-{{ $branch }}
    trigger: true
    version: "every"
    passed:
    - lint-{{ $branch }}
{{- if has $stable "build" }}
  - put: status-{{ $branch }}.src
    params: &build_{{ $sanitized_branch_name }}_status
        context: build
        description: "Build started"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: build
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: thulioassis/bazel-docker-image
          tag: 2.0.0
      inputs:
      - name: kubecf-{{ $branch }}
      outputs:
      - name: output
      run:
        path: "/bin/bash"
        args:
        - -ce
        - |
          cd kubecf-{{ $branch }}
          ./dev/build.sh ../output
          timestamp=$(date +%s%3N)
          for file in ../output/*.tgz; do
              mv "$file" "${file%.tgz}-${timestamp}.tgz"
          done

{{- if has $stable "build" }}
    on_success:
      put: status-{{ $branch }}.src
      params:
        << : *build_{{ $sanitized_branch_name }}_status
        state: success
    on_failure:
      put: status-{{ $branch }}.src
      params:
        << : *build_{{ $sanitized_branch_name }}_status
        state: failure
{{- end }}
  - put: s3.kubecf-ci
    params:
      file: output/kubecf-v*.tgz
      acl: public-read
  - put: s3.kubecf-ci-bundle
    params:
      file: output/kubecf-bundle-v*.tgz
      acl: public-read

{{- range $_, $cfScheduler := $availableCfSchedulers }}

# prod-jobs
- name: deploy-{{ $cfScheduler }}-{{ $branch }}
  #max_in_flight: 1 # Re-enable to when we want to set a limit on concurrent deployments
  public: true
  # Consider adding a serial_group between the two $cfScheduler
  # if jobs starts to starve
  plan:
  - get: kubecf-{{ $branch }}
    trigger: true
    version: "every"
    passed:
    - build-{{ $branch }}
  - get: s3.kubecf-ci
    passed:
    - build-{{ $branch }}
  - get: s3.kubecf-ci-bundle
    passed:
    - build-{{ $branch }}
  - get: catapult
{{- if has $stable (printf "deploy-%s" $cfScheduler) }}
  - put: status-{{ $branch }}.src
    params: &deploy_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        context: "deploy-{{ $cfScheduler }}"
        description: "Deploy {{ $cfScheduler }}"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - put: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    params: {bump: patch}
  - task: deploy
    timeout: 3h30m
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: kubecf
      - name: catapult
      - name: s3.kubecf-ci
      - name: semver.gke-cluster
      outputs:
      - name: output
      params:
        DEFAULT_STACK: cflinuxfs3
        CATS_NODES: 5
        ENABLE_EIRINI: {{ eq $cfScheduler "eirini" }}
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *deploy_args
{{- if has $stable (printf "deploy-%s" $cfScheduler) }}
  on_success:
    do:
    - put: status-{{ $branch }}.src
      params:
        << : *deploy_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        state: success
{{- end }}
  on_failure:
    in_parallel:
{{- if has $stable (printf "deploy-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *deploy_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
    - try: &cleanup-cluster
        task: cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
        input_mapping:
          semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: splatform/catapult
          inputs:
          - name: semver.gke-cluster
          run:
            path: "/bin/bash"
            args:
            - -ce
            - |

              # Login to gcloud
              printf "%s" '((gke-suse-cap-json))' > $PWD/gke-key.json
              gcloud auth activate-service-account --key-file $PWD/gke-key.json
              export GKE_PROJECT={{ if has . "gke_project" }}{{ .gke_project }}{{ else }}"suse-225215"{{ end }}
              export GKE_CLUSTER_ZONE={{ if has . "gke_zone" }}{{ .gke_zone }}{{ else }}"europe-west3-c"{{ end }}
              export GKE_CLUSTER_NAME="kubecf-ci-${BRANCH}-${CFSCHEDULER}-$(cat semver.gke-cluster/version | sed 's/\./-/g')"

              # Obtain pvc disks that are not used
              # https://groups.google.com/d/msg/gce-discussion/RLrwOx8fazo/9ve7lIdsBQAJ
              IDS=$(gcloud compute disks list \
                    --filter="zone~${GKE_CLUSTER_ZONE}" \
                    --filter="name~pvc" \
                    --filter="-users:*"
                    --format="value(id)" \
                    --project=${GKE_PROJECT})
              # Delete cluster
              gcloud --quiet container --project "${GKE_PROJECT}" clusters delete "${GKE_CLUSTER_NAME}" \
                    --zone "${GKE_CLUSTER_ZONE}"
              # Delete pvc disks associated to the cluster, now that they are free
              for ID in ${IDS}; do
                  gcloud compute disks delete ${ID} --zone=${GKE_CLUSTER_ZONE} \
                                                    --project="${GKE_PROJECT}" --quiet;
              done
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "deploy-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *deploy_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "deploy-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *deploy_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}

{{ $previousTest := "" }}

- name: smoke-tests-{{ $cfScheduler }}-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    trigger: true
    version: "every"
    passed:
    - deploy-{{ $cfScheduler }}-{{ $branch }}
  - get: s3.kubecf-ci
    passed:
    - deploy-{{ $cfScheduler }}-{{ $branch }}
  - get: s3.kubecf-ci-bundle
    passed:
    - deploy-{{ $cfScheduler }}-{{ $branch }}
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - deploy-{{ $cfScheduler }}-{{ $branch }}
    trigger: true
  - get: catapult
{{- if has $stable (printf "smoke-tests-%s" $cfScheduler) }}
  - put: status-{{ $branch }}.src
    params: &smoke_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        context: "smoke-tests-{{ $cfScheduler }}"
        description: "Smoke tests {{ $cfScheduler }}"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: test-{{ $cfScheduler }}
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    timeout: 1h30m
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: catapult
      - name: kubecf
      - name: semver.gke-cluster
      params:
        DEFAULT_STACK: cflinuxfs3
        TEST_SUITE: smokes
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *test_args
{{- if has $stable (printf "smoke-tests-%s" $cfScheduler) }}
  on_success:
    put: status-{{ $branch }}.src
    params:
      << : *smoke_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
      state: success
{{- end }}
  on_failure:
    in_parallel:
{{- if has $stable (printf "smoke-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "smoke-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "smoke-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
{{ $previousTest = (printf "smoke-tests-%s-%s" $cfScheduler $branch) }}

- name: cf-acceptance-tests-{{ $cfScheduler }}-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
    version: "every"
  - get: s3.kubecf-ci
    passed:
    - {{ $previousTest | quote }}
  - get: s3.kubecf-ci-bundle
    passed:
    - {{ $previousTest | quote }}
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
  - get: catapult
{{- if has $stable (printf "cf-acceptance-tests-%s" $cfScheduler) }}
  - put: status-{{ $branch }}.src
    params: &cats_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        context: "cf-acceptance-tests-{{ $cfScheduler }}"
        description: "Acceptance tests {{ $cfScheduler }}"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: test-{{ $cfScheduler }}
    timeout: 5h30m
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: catapult
      - name: kubecf
      - name: semver.gke-cluster
      params:
        DEFAULT_STACK: cflinuxfs3
        TEST_SUITE: cats
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *test_args

{{- if has $stable (printf "cf-acceptance-tests-%s" $cfScheduler) }}
  on_success:
    put: status-{{ $branch }}.src
    params:
      << : *cats_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
      state: success
{{- end }}

  on_failure:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "cf-acceptance-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *cats_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "cf-acceptance-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *cats_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "cf-acceptance-tests-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *cats_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
{{ $previousTest = (printf "cf-acceptance-tests-%s-%s" $cfScheduler $branch) }}

# no-prod jobs

{{- if eq $cfScheduler "diego" }}
- name: sync-integration-tests-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
    version: "every"
  - get: s3.kubecf-ci
    passed:
    - {{ $previousTest | quote }}
  - get: s3.kubecf-ci-bundle
    passed:
    - {{ $previousTest | quote }}
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
  - get: catapult
{{- if has $stable "sync-integration-tests" }}
  - put: status-{{ $branch }}.src
    params: &sits_{{ $sanitized_branch_name }}_status
        context: "sync-integration-tests"
        description: "Sync Integration tests"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: test-{{ $cfScheduler }}
    timeout: 1h30m
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: catapult
      - name: kubecf
      - name: semver.gke-cluster
      params:
        DEFAULT_STACK: cflinuxfs3
        TEST_SUITE: sits
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *test_args
{{- if has $stable "sync-integration-tests" }}
  on_success:
    put: status-{{ $branch }}.src
    params:
      << : *sits_{{ $sanitized_branch_name }}_status
      state: success
{{- end }}
  on_failure:
    in_parallel:
{{- if has $stable "sync-integration-tests" }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *sits_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable "sync-integration-tests" }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *sits_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}

  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable "sync-integration-tests" }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *sits_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
{{ $previousTest = (printf "sync-integration-tests-%s" $branch) }}
{{- end }}

- name: ccdb-rotate-{{ $cfScheduler }}-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
    version: "every"
  - get: s3.kubecf-ci
    passed:
    - {{ $previousTest | quote }}
  - get: s3.kubecf-ci-bundle
    passed:
    - {{ $previousTest | quote }}
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
  - get: catapult
{{- if has $stable (printf "rotate-%s" $cfScheduler) }}
  - put: status-{{ $branch }}.src
    params: &rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        context: "rotate-{{ $cfScheduler }}"
        description: "Rotating secrets {{ $cfScheduler }}"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: rotate-{{ $cfScheduler }}
    timeout: 1h30m
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: catapult
      - name: kubecf
      - name: semver.gke-cluster
      params:
        DEFAULT_STACK: cflinuxfs3
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *rotate_args

{{- if has $stable (printf "rotate-%s" $cfScheduler) }}
  on_success:
    put: status-{{ $branch }}.src
    params:
      << : *rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
      state: success
{{- end }}

  on_failure:
    in_parallel:
{{- if has $stable (printf "rotate-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "rotate-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "rotate-%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
{{ $previousTest = (printf "ccdb-rotate-%s-%s" $cfScheduler $branch) }}

- name: smoke-tests-post-rotate-{{ $cfScheduler }}-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
    version: "every"
  - get: s3.kubecf-ci
    passed:
    - {{ $previousTest | quote }}
  - get: s3.kubecf-ci-bundle
    passed:
    - {{ $previousTest | quote }}
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
  - get: catapult
{{- if has $stable (printf "smoke-rotated-{%s" $cfScheduler) }}
  - put: status-{{ $branch }}.src
    params: &smoke_rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
        context: "smoke-rotated-{{ $cfScheduler }}"
        description: "Smoke tests after rotating secrets {{ $cfScheduler }}"
        path: kubecf-{{ $branch }}/{{ $path }}
        state: pending
{{- end }}
  - task: test-{{ $cfScheduler }}
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    timeout: 1h30m
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      inputs:
      - name: catapult
      - name: kubecf
      - name: semver.gke-cluster
      params:
        DEFAULT_STACK: cflinuxfs3
        TEST_SUITE: smokes
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}
      run:
        path: "/bin/bash"
        args: *test_args

{{- if has $stable (printf "smoke-rotated-{%s" $cfScheduler) }}
  on_success:
    put: status-{{ $branch }}.src
    params:
      << : *smoke_rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
      state: success
{{- end }}

  on_failure:
    in_parallel:
{{- if has $stable (printf "smoke-rotated-{%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
  on_abort:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "smoke-rotated-{%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
  on_error:
    in_parallel:
    - try:
        << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: {{ $cfScheduler }}
{{- if has $stable (printf "smoke-rotated-{%s" $cfScheduler) }}
    - try:
        put: status-{{ $branch }}.src
        params:
          << : *smoke_rotate_{{ $cfScheduler }}_{{ $sanitized_branch_name }}_status
          state: failure
{{- end }}
{{ $previousTest = (printf "smoke-tests-post-rotate-%s-%s" $cfScheduler $branch) }}

# TODO: re-enable and re-adapt once BRAIN tests are fixed.
# - name: brain-tests-{{ $cfScheduler }}
#   public: true
#   plan:
#   - get: commit-to-test
#     passed:
#     - sync-integration-tests-{{ $cfScheduler }}
#     trigger: true
#     version: "every"
#   - get: s3.kubecf-ci
#     passed:
#     - sync-integration-tests-{{ $cfScheduler }}
#   - get: s3.kubecf-ci-bundle
#     passed:
#     - sync-integration-tests-{{ $cfScheduler }}
#   - get: catapult
#   - task: test-{{ $cfScheduler }}
#     timeout: 1h30m
#     config:
#       platform: linux
#       image_resource:
#         type: registry-image
#         source:
#           repository: splatform/catapult
#       inputs:
#       - name: catapult
#       - name: commit-to-test
#       outputs:
#       - name: output
#       params:
#         DEFAULT_STACK: cflinuxfs3
#         EKCP_HOST: ((ekcp-host))
#         TEST_SUITE: brain
#       run:
#         path: "/bin/bash"
#         args: *test_args
#     on_success:
#       put: commit-to-test
#       params:
#         description: "Brain tests on {{ $cfScheduler }} succeeded"
#         state: "success"
#         contexts: "brain-tests-{{ $cfScheduler }}"
#         commit_path: "commit-to-test/.git/resource/ref"
#         version_path: "commit-to-test/.git/resource/version"
#     on_failure:
#       do:
#       - put: commit-to-test
#         params:
#           description: "Brain tests on {{ $cfScheduler }} failed"
#           state: "failure"
#           commit_path: "commit-to-test/.git/resource/ref"
#           version_path: "commit-to-test/.git/resource/version"
#           contexts: "brain-tests-{{ $cfScheduler }}"
#       - task: cleanup-cluster
#         config:
#           <<: *cleanup-cluster
#           params:
#             EKCP_HOST: ((ekcp-host))
#     on_abort:
#       task: cleanup-cluster
#       config:
#         <<: *cleanup-cluster
#         params:
#           EKCP_HOST: ((ekcp-host))


- name: cleanup-{{ $cfScheduler }}-cluster-{{ $branch }}
  public: true
  plan:
  - get: kubecf-{{ $branch }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
    version: "every"
  - get: semver.gke-cluster-{{ $branch }}-{{ $cfScheduler }}
    passed:
    - {{ $previousTest | quote }}
    trigger: true
  ensure:
   do:
    - << : *cleanup-cluster
      params:
        BRANCH: {{ $branch }}
        CFSCHEDULER: {{ $cfScheduler }}

{{ end }} # of range cfScheduler

- name: upgrade-test-{{ $branch }}
  plan:
  - in_parallel:
    - get: kubecf-github-release
    - get: kubecf-{{ $branch }}
      trigger: true
      version: "every"
      passed:
      - build-{{ $branch }}
    - get: s3.kubecf-ci
      passed:
      - build-{{ $branch }}
    - get: s3.kubecf-ci-bundle
      passed:
      - build-{{ $branch }}
    - get: catapult
    - put: semver.gke-cluster-{{ $branch }}-upgrade
      params: {bump: patch}
  - task: upgrade
    params:
      BRANCH: {{ $branch }}
    input_mapping:
      kubecf: kubecf-{{ $branch }}
      semver.gke-cluster: semver.gke-cluster-{{ $branch }}-upgrade
    timeout: 4h
    file: kubecf-{{ $branch }}/.concourse/tasks/upgrade.yaml
  ensure:
    do:
      - << : *cleanup-cluster
        params:
          BRANCH: {{ $branch }}
          CFSCHEDULER: upgrade

{{ if not ($branch | regexp.Match "^pr|fork-pr") }}
- name: publish-{{ $branch }}
  public: true
  plan:
  - get: s3.kubecf-ci
    passed:
    - cf-acceptance-tests-diego-{{ $branch }}
    trigger: true
  - get: s3.kubecf-ci-bundle
    passed:
    - cf-acceptance-tests-diego-{{ $branch }}
    trigger: true
  - task: rename-artifacts
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: thulioassis/bazel-docker-image
          tag: 2.0.0
      inputs:
      - name: s3.kubecf-ci
      - name: s3.kubecf-ci-bundle
      outputs:
      - name: output
      run:
        path: "/bin/bash"
        args:
        - -ce
        - |
          # Revert to original name without the timestamp part
          for file in s3.kubecf-ci*/*.tgz; do
              new_filename=$(basename $file | sed  's/-[0-9]\+\.tgz/\.tgz/')
              mv "$file" "output/${new_filename}"
          done
  - task: test-if-file-exists
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: splatform/catapult
      params:
        S3_BUCKET: {{ if has . "s3_final_bucket" }}{{ .s3_final_bucket }}{{ else }}kubecf{{ end }}
        AWS_ACCESS_KEY_ID: ((aws-access-key))
        AWS_SECRET_ACCESS_KEY: ((aws-secret-key))
      inputs:
      - name: output
      run:
        path: "/bin/bash"
        args:
        - -ce
        - |
          # Make sure that tarballs do not exist on s3 yet
          for file in output/*.tgz; do
              aws s3 ls "s3://${S3_BUCKET}/$(basename $file)" && (echo "Tarball already exists on s3. Aborting."; exit 1);
          done
          exit 0
  - put: s3.kubecf
    params:
      file: output/kubecf-v*.tgz
  - put: s3.kubecf-bundle
    params:
      file: output/kubecf-bundle-v*.tgz
{{ end }} # of publish
{{ end }} # of branch
